var atmosphere=(function(exports){'use strict';var w=class{constructor(t="warn"){this.level=t;}setLevel(t){this.level=t;}debug(t,...e){this.shouldLog("debug")&&console.debug(`[Atmosphere] ${t}`,...e);}info(t,...e){this.shouldLog("info")&&console.info(`[Atmosphere] ${t}`,...e);}warn(t,...e){this.shouldLog("warn")&&console.warn(`[Atmosphere] ${t}`,...e);}error(t,...e){this.shouldLog("error")&&console.error(`[Atmosphere] ${t}`,...e);}shouldLog(t){let e=["debug","info","warn","error","silent"],s=e.indexOf(this.level);return e.indexOf(t)>=s}},i=new w;var q="5.0.0-alpha.2";var g=class{constructor(){this.uuid="0";this.firstMessage=true;this.heartbeatInterval=0;this.heartbeatPadding="X";this.heartbeatTimer=null;this.partialMessage="";this.pushFn=null;}setPushFunction(t){this.pushFn=t;}buildUrl(t){let e=t.url,s=e.includes("?")?"&":"?",r=[];if(r.push(`X-Atmosphere-tracking-id=${encodeURIComponent(this.uuid)}`),r.push(`X-Atmosphere-Framework=${encodeURIComponent(q)}`),r.push(`X-Atmosphere-Transport=${encodeURIComponent(t.transport)}`),t.trackMessageLength&&r.push("X-Atmosphere-TrackMessageSize=true"),t.heartbeat?.server&&r.push(`X-Heartbeat-Server=${t.heartbeat.server}`),t.contentType&&r.push(`Content-Type=${t.transport==="websocket"?t.contentType:encodeURIComponent(t.contentType)}`),t.enableProtocol&&r.push("X-atmo-protocol=true"),t.headers)for(let[o,n]of Object.entries(t.headers))r.push(`${encodeURIComponent(o)}=${encodeURIComponent(n)}`);return e+s+r.join("&")}handleProtocol(t,e){if(t.transport==="polling")return {message:e,wasHandshake:false};if(t.enableProtocol&&this.firstMessage&&e.trim().length>0){let s=t.messageDelimiter??"|",r=t.trackMessageLength?1:0,o=e.split(s);if(o.length<=r+1)return {message:e,wasHandshake:false};this.firstMessage=false,this.uuid=o[r].trim(),this.heartbeatInterval=parseInt(o[r+1]?.trim()??"0",10),this.heartbeatPadding=o[r+2]??"X";let n=t.trackMessageLength?4:3,a="";return o.length>n+1&&(a=o.slice(n).join(s)),i.debug(`Protocol handshake: uuid=${this.uuid}, heartbeat=${this.heartbeatInterval}ms`),{message:a,wasHandshake:true}}return {message:e,wasHandshake:false}}processMessage(t,e){let{message:s}=this.handleProtocol(e,t);if(s.length===0)return null;if(!e.trackMessageLength)return {body:s,messages:[s]};let r=e.messageDelimiter??"|",o=this.partialMessage+s,n=[],a=o.indexOf(r);for(;a!==-1;){let h=o.substring(0,a),u=parseInt(h,10);if(isNaN(u))throw this.partialMessage="",new Error(`Message length "${h}" is not a number`);let d=a+r.length;if(d+u>o.length)break;n.push(o.substring(d,d+u)),o=o.substring(d+u),a=o.indexOf(r);}return this.partialMessage=o,n.length===0?null:{body:n.join(r),messages:n}}startHeartbeat(){if(this.stopHeartbeat(),this.heartbeatInterval>0&&this.pushFn){let t=()=>{i.debug("Sending heartbeat"),this.pushFn?.(this.heartbeatPadding),this.heartbeatTimer=setTimeout(t,this.heartbeatInterval);};this.heartbeatTimer=setTimeout(t,this.heartbeatInterval);}}stopHeartbeat(){this.heartbeatTimer!==null&&(clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null);}reset(){this.firstMessage=true,this.partialMessage="",this.stopHeartbeat();}};var l=class{constructor(t,e,s=[]){this._state="disconnected";this._hasOpened=false;this._inactivityTimer=null;this._requestCount=0;this.request=t,this.handlers=e,this.protocol=new g,this.interceptors=s;}get state(){return this._state}get uuid(){return this.protocol.uuid}get hasOpened(){return this._hasOpened}async connectWithTimeout(){let t=this.request.connectTimeout;return !t||t<=0?this.connect():new Promise((e,s)=>{let r=setTimeout(()=>{s(new Error(`Connect timeout after ${t}ms`));},t);this.connect().then(()=>{clearTimeout(r),e();}).catch(o=>{clearTimeout(r),s(o);});})}suspend(){this._state==="connected"&&(this._state="suspended",this.stopInactivityTimer(),i.info(`${this.name} suspended`));}async resume(){this._state==="suspended"&&(this._state="connected",this.resetInactivityTimer(),i.info(`${this.name} resumed`));}applyOutgoing(t){let e=t;for(let s of this.interceptors)s.onOutgoing&&(e=s.onOutgoing(e));return e}applyIncoming(t){let e=t;for(let s=this.interceptors.length-1;s>=0;s--)this.interceptors[s].onIncoming&&(e=this.interceptors[s].onIncoming(e));return e}notifyOpen(t){this._hasOpened?(this._state="connected",i.debug(`${this.name} transport reopened`),this.handlers.reopen?.(t)):(this._hasOpened=true,this._state="connected",i.debug(`${this.name} transport opened`),this.handlers.open?.(t)),this.resetInactivityTimer();}notifyMessage(t){this._state!=="suspended"&&(i.debug(`${this.name} message received`),this.resetInactivityTimer(),this.handlers.message?.(t));}notifyClose(t){this._state="closed",this.stopInactivityTimer(),i.debug(`${this.name} transport closed`),this.handlers.close?.(t);}notifyError(t){this._state="error",this.stopInactivityTimer(),i.error(`${this.name} transport error:`,t),this.handlers.error?.(t);}notifyReconnect(t,e){this._state="reconnecting",i.info(`${this.name} reconnecting...`),this.handlers.reconnect?.(t,e);}notifyFailureToReconnect(t){i.warn(`${this.name} all reconnect attempts exhausted`),this.handlers.failureToReconnect?.(this.request,t);}isMaxRequestReached(){let t=this.request.maxRequest;return t!==void 0&&t>0&&this._requestCount>=t}resetInactivityTimer(){this.stopInactivityTimer();let t=this.request.timeout;t&&t>0&&(this._inactivityTimer=setTimeout(()=>{i.warn(`${this.name} inactivity timeout after ${t}ms`),this.handlers.clientTimeout?.(this.request);},t));}stopInactivityTimer(){this._inactivityTimer&&(clearTimeout(this._inactivityTimer),this._inactivityTimer=null);}};var f=class extends l{constructor(){super(...arguments);this.ws=null;this.reconnectAttempts=0;this.reconnectTimer=null;}get name(){return "websocket"}async connect(){return new Promise((e,s)=>{try{this._state="connecting";let r=this.buildWebSocketUrl(this.request.url);i.debug(`Connecting to WebSocket: ${r}`),this.ws=new WebSocket(r),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{this.handleOpen(),e();},this.ws.onmessage=o=>{this.handleMessage(o);},this.ws.onerror=()=>{let o=new Error("WebSocket connection error");this.handleError(o),s(o);},this.ws.onclose=o=>{this.handleClose(o);};}catch(r){this.handleError(r),s(r);}})}async disconnect(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.protocol.stopHeartbeat(),this.ws?.readyState===WebSocket.OPEN&&this.ws.close(),this.ws=null,this._state="disconnected";}send(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)throw new Error("WebSocket is not connected");this.ws.send(this.applyOutgoing(e));}buildWebSocketUrl(e){let s=new URL(this.protocol.buildUrl(this.request),window.location.href);return s.protocol=s.protocol.replace("http","ws"),s.toString()}handleOpen(){this.reconnectAttempts=0,i.info("WebSocket connection established"),this.protocol.setPushFunction(s=>this.send(s));let e={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:{},state:"open",transport:"websocket",error:null,request:this.request};this.request.enableProtocol||(this.notifyOpen(e),this.protocol.startHeartbeat());}handleMessage(e){if(e.data instanceof ArrayBuffer){let r={status:200,reasonPhrase:"OK",responseBody:e.data,messages:[e.data],headers:{},state:"messageReceived",transport:"websocket",error:null,request:this.request};this.notifyMessage(r);return}let s=this.protocol.processMessage(e.data,this.request);if(s===null){if(this.request.enableProtocol&&this._state!=="connected"){let r={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:{},state:"open",transport:"websocket",error:null,request:this.request};this.notifyOpen(r),this.protocol.startHeartbeat();}return}for(let r of s.messages){if(r===this.protocol.heartbeatPadding)continue;let o={status:200,reasonPhrase:"OK",responseBody:this.applyIncoming(r),messages:[r],headers:{},state:"messageReceived",transport:"websocket",error:null,request:this.request};this.notifyMessage(o);}}handleClose(e){if(this.request.closed)return;i.info(`WebSocket closed: code=${e.code}, reason=${e.reason}`),this.protocol.stopHeartbeat();let s={status:e.code,reasonPhrase:e.reason||"Connection closed",responseBody:"",messages:[],headers:{},state:"closed",transport:"websocket",error:null,request:this.request};this.notifyClose(s),this.request.reconnect&&this.reconnectAttempts<(this.request.maxReconnectOnClose??5)?this.scheduleReconnect():this.request.reconnect&&this.notifyFailureToReconnect(s);}handleError(e){i.error("WebSocket error:",e),this.protocol.stopHeartbeat(),this.notifyError(e);}scheduleReconnect(){let e=this.calculateReconnectDelay();this.reconnectAttempts++,i.info(`Scheduling reconnection attempt ${this.reconnectAttempts} in ${e}ms`),this.notifyReconnect(this.request,{status:0,reasonPhrase:"Reconnecting",responseBody:"",messages:[],headers:{},state:"reconnecting",transport:"websocket",error:null,request:this.request}),this.reconnectTimer=setTimeout(()=>{this.protocol.reset(),this.connect().catch(s=>{i.error("Reconnection failed:",s);});},e);}calculateReconnectDelay(){let s=(this.request.reconnectInterval??1e3)*Math.pow(2,Math.min(this.reconnectAttempts,5)),r=.5+Math.random()*.5;return s*r}};var b=class p extends l{constructor(){super(...arguments);this.eventSource=null;this.reconnectAttempts=0;this.reconnectTimer=null;}get name(){return "sse"}static isAvailable(){return typeof EventSource<"u"}async connect(){if(!p.isAvailable())throw new Error("SSE (EventSource) is not supported in this environment");return new Promise((e,s)=>{try{this._state="connecting";let r=this.protocol.buildUrl(this.request);i.debug(`Connecting SSE: ${r}`),this.eventSource=new EventSource(r,{withCredentials:this.request.withCredentials??!1}),this.eventSource.onopen=()=>{this.handleOpen(),e();},this.eventSource.onmessage=o=>{this.handleMessage(o);},this.eventSource.onerror=()=>{if(this._state==="connecting"){let o=new Error("SSE connection failed");this.handleError(o),s(o);}else this.handleClose();};}catch(r){this.handleError(r),s(r);}})}async disconnect(){this.reconnectTimer!==null&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.protocol.stopHeartbeat(),this.eventSource&&(this.eventSource.close(),this.eventSource=null),this._state="disconnected";}send(e){let s=this.protocol.buildUrl(this.request),r=this.applyOutgoing(e),o=r instanceof ArrayBuffer?new Blob([r]):r,n=new XMLHttpRequest;n.open("POST",s,true),n.setRequestHeader("Content-Type",this.request.contentType??"text/plain"),this.request.withCredentials&&(n.withCredentials=true),n.send(o);}handleOpen(){this.reconnectAttempts=0,i.info("SSE connection established"),this.protocol.setPushFunction(s=>this.send(s));let e={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:{},state:"open",transport:"sse",error:null,request:this.request};this.request.enableProtocol||(this.notifyOpen(e),this.protocol.startHeartbeat());}handleMessage(e){let s=this.protocol.processMessage(e.data,this.request);if(s===null){if(this.request.enableProtocol&&this._state!=="connected"){let r={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:{},state:"open",transport:"sse",error:null,request:this.request};this.notifyOpen(r),this.protocol.startHeartbeat();}return}for(let r of s.messages){if(r===this.protocol.heartbeatPadding)continue;let o={status:200,reasonPhrase:"OK",responseBody:this.applyIncoming(r),messages:[r],headers:{},state:"messageReceived",transport:"sse",error:null,request:this.request};this.notifyMessage(o);}}handleClose(){i.info("SSE connection closed"),this.protocol.stopHeartbeat();let e={status:0,reasonPhrase:"SSE connection lost",responseBody:"",messages:[],headers:{},state:"closed",transport:"sse",error:null,request:this.request};this.notifyClose(e),this.eventSource&&(this.eventSource.close(),this.eventSource=null),this.request.reconnect&&this.reconnectAttempts<(this.request.maxReconnectOnClose??5)?this.scheduleReconnect():this.request.reconnect&&this.notifyFailureToReconnect(e);}handleError(e){i.error("SSE error:",e),this.protocol.stopHeartbeat(),this.notifyError(e);}scheduleReconnect(){let e=this.calculateReconnectDelay();this.reconnectAttempts++,i.info(`SSE reconnect attempt ${this.reconnectAttempts} in ${e}ms`),this.notifyReconnect(this.request,{status:0,reasonPhrase:"Reconnecting",responseBody:"",messages:[],headers:{},state:"reconnecting",transport:"sse",error:null,request:this.request}),this.reconnectTimer=setTimeout(()=>{this.protocol.reset(),this.connect().catch(s=>{i.error("SSE reconnection failed:",s);});},e);}calculateReconnectDelay(){let s=(this.request.reconnectInterval??1e3)*Math.pow(2,Math.min(this.reconnectAttempts,5)),r=.5+Math.random()*.5;return s*r}};var y=class extends l{constructor(){super(...arguments);this.xhr=null;this.reconnectAttempts=0;this.reconnectTimer=null;this._polling=false;this.aborted=false;}get name(){return "long-polling"}async connect(){return this._state="connecting",this.aborted=false,this._polling=true,this.protocol.setPushFunction(e=>this.send(e)),this.poll(true)}async disconnect(){this.aborted=true,this._polling=false,this.reconnectTimer!==null&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.protocol.stopHeartbeat(),this.xhr&&(this.xhr.abort(),this.xhr=null),this._state="disconnected";}send(e){let s=this.protocol.buildUrl(this.request),r=this.applyOutgoing(e),o=r instanceof ArrayBuffer?new Blob([r]):r,n=new XMLHttpRequest;n.open("POST",s,true),n.setRequestHeader("Content-Type",this.request.contentType??"text/plain"),this.request.withCredentials&&(n.withCredentials=true),n.send(o);}async poll(e){if(!this.aborted){if(this.isMaxRequestReached()){i.info("Long-polling maxRequest reached");return}return new Promise((s,r)=>{let o=this.protocol.buildUrl(this.request);i.debug(`Long-polling request: ${o}`);let n=new XMLHttpRequest;this.xhr=n,n.open("GET",o,true),n.setRequestHeader("Content-Type",this.request.contentType??"text/plain"),this.request.withCredentials&&(n.withCredentials=true),n.onreadystatechange=()=>{if(!this.aborted&&n.readyState===4)if(n.status>=200&&n.status<300){if(e){this.reconnectAttempts=0;let h={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:{},state:"open",transport:"long-polling",error:null,request:this.request};this.notifyOpen(h),this.protocol.startHeartbeat();}let a=n.responseText;a.trim().length>0&&this.handleResponse(a),s(),this._polling&&!this.aborted&&this.poll(false).catch(h=>{i.error("Long-polling re-poll failed:",h);});}else n.status===0&&this.aborted?s():this.handleDisconnect(e,s,r);},n.onerror=()=>{if(this.aborted){s();return}this.handleDisconnect(e,s,r);},n.send(null),this._requestCount++;})}}handleResponse(e){let s=this.protocol.processMessage(e,this.request);if(s!==null)for(let r of s.messages){if(r===this.protocol.heartbeatPadding)continue;let o={status:200,reasonPhrase:"OK",responseBody:this.applyIncoming(r),messages:[r],headers:{},state:"messageReceived",transport:"long-polling",error:null,request:this.request};this.notifyMessage(o);}}handleDisconnect(e,s,r){if(this.protocol.stopHeartbeat(),e){let n=new Error("Long-polling connection failed");this.notifyError(n),r(n);return}let o={status:0,reasonPhrase:"Long-polling connection lost",responseBody:"",messages:[],headers:{},state:"closed",transport:"long-polling",error:null,request:this.request};this.notifyClose(o),s(),this._polling&&this.request.reconnect&&this.reconnectAttempts<(this.request.maxReconnectOnClose??5)?this.scheduleReconnect():this._polling&&this.request.reconnect&&this.notifyFailureToReconnect(o);}scheduleReconnect(){let e=this.calculateReconnectDelay();this.reconnectAttempts++,i.info(`Long-polling reconnect attempt ${this.reconnectAttempts} in ${e}ms`),this.notifyReconnect(this.request,{status:0,reasonPhrase:"Reconnecting",responseBody:"",messages:[],headers:{},state:"reconnecting",transport:"long-polling",error:null,request:this.request}),this.reconnectTimer=setTimeout(()=>{this.protocol.reset(),this.poll(true).catch(s=>{i.error("Long-polling reconnection failed:",s);});},e);}calculateReconnectDelay(){let s=(this.request.reconnectInterval??1e3)*Math.pow(2,Math.min(this.reconnectAttempts,5)),r=.5+Math.random()*.5;return s*r}};var v=class extends l{constructor(){super(...arguments);this.xhr=null;this.lastIndex=0;this.reconnectAttempts=0;this.reconnectTimer=null;this.aborted=false;this.opened=false;}get name(){return "streaming"}async connect(){return this._state="connecting",this.aborted=false,this.lastIndex=0,this.opened=false,this.protocol.setPushFunction(e=>this.send(e)),new Promise((e,s)=>{let r=this.protocol.buildUrl(this.request);i.debug(`Streaming connect: ${r}`);let o=new XMLHttpRequest;this.xhr=o,o.open("GET",r,true),o.setRequestHeader("Content-Type",this.request.contentType??"text/plain"),this.request.withCredentials&&(o.withCredentials=true),o.onreadystatechange=()=>{if(!this.aborted){if(o.readyState>=3){if(!this.opened&&o.status>=200&&o.status<300){this.opened=true,this.reconnectAttempts=0;let n={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:{},state:"open",transport:"streaming",error:null,request:this.request};this.request.enableProtocol||(this.notifyOpen(n),this.protocol.startHeartbeat()),e();}if(o.readyState>=3&&o.responseText.length>this.lastIndex){let n=o.responseText.substring(this.lastIndex);this.lastIndex=o.responseText.length,this.handleChunk(n);}}if(o.readyState===4)if(this.opened)this.handleClose();else {let n=new Error(`Streaming connection failed: ${o.status}`);this.handleError(n),s(n);}}},o.onerror=()=>{if(this.aborted){e();return}if(this.opened)this.handleClose();else {let n=new Error("Streaming connection error");this.handleError(n),s(n);}},o.send(null);})}async disconnect(){this.aborted=true,this.reconnectTimer!==null&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.protocol.stopHeartbeat(),this.xhr&&(this.xhr.abort(),this.xhr=null),this._state="disconnected";}send(e){let s=this.protocol.buildUrl(this.request),r=this.applyOutgoing(e),o=r instanceof ArrayBuffer?new Blob([r]):r,n=new XMLHttpRequest;n.open("POST",s,true),n.setRequestHeader("Content-Type",this.request.contentType??"text/plain"),this.request.withCredentials&&(n.withCredentials=true),n.send(o);}handleChunk(e){let s=this.protocol.processMessage(e,this.request);if(s===null){if(this.request.enableProtocol&&this._state!=="connected"){let r={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:{},state:"open",transport:"streaming",error:null,request:this.request};this.notifyOpen(r),this.protocol.startHeartbeat();}return}for(let r of s.messages){if(r===this.protocol.heartbeatPadding)continue;let o={status:200,reasonPhrase:"OK",responseBody:this.applyIncoming(r),messages:[r],headers:{},state:"messageReceived",transport:"streaming",error:null,request:this.request};this.notifyMessage(o);}}handleClose(){i.info("Streaming connection closed"),this.protocol.stopHeartbeat();let e={status:0,reasonPhrase:"Streaming connection closed",responseBody:"",messages:[],headers:{},state:"closed",transport:"streaming",error:null,request:this.request};this.notifyClose(e),!this.aborted&&this.request.reconnect&&this.reconnectAttempts<(this.request.maxReconnectOnClose??5)?this.scheduleReconnect():!this.aborted&&this.request.reconnect&&this.notifyFailureToReconnect(e);}handleError(e){i.error("Streaming error:",e),this.protocol.stopHeartbeat(),this.notifyError(e);}scheduleReconnect(){let e=this.calculateReconnectDelay();this.reconnectAttempts++,i.info(`Streaming reconnect attempt ${this.reconnectAttempts} in ${e}ms`),this.notifyReconnect(this.request,{status:0,reasonPhrase:"Reconnecting",responseBody:"",messages:[],headers:{},state:"reconnecting",transport:"streaming",error:null,request:this.request}),this.reconnectTimer=setTimeout(()=>{this.protocol.reset(),this.lastIndex=0,this.opened=false,this.connect().catch(s=>{i.error("Streaming reconnection failed:",s);});},e);}calculateReconnectDelay(){let s=(this.request.reconnectInterval??1e3)*Math.pow(2,Math.min(this.reconnectAttempts,5)),r=.5+Math.random()*.5;return s*r}};var R=class{constructor(t={}){this.version="5.0.0-alpha.2";this.subscriptions=new Map;this.subscriptionId=0;this.config=t,t.logLevel&&i.setLevel(t.logLevel);}async subscribe(t,e={}){let s=`sub-${++this.subscriptionId}`,r=t.transport||this.config.defaultTransport||"websocket",o=t.fallbackTransport??this.config.fallbackTransport;i.info(`Creating subscription ${s} to ${t.url} via ${r}`);let n={...t,transport:r},a;try{a=this.createTransport(n,e),await a.connectWithTimeout();}catch(c){if(o&&o!==r){let m=c instanceof Error?c.message:String(c);i.info(`${r} failed, falling back to ${o}`),e.transportFailure?.(m,n);let T={...n,transport:o};a=this.createTransport(T,e),await a.connectWithTimeout();}else throw c}let h=a,u=new Map,d={id:s,get state(){return h.state},push:c=>{let m=typeof c=="string"||c instanceof ArrayBuffer?c:JSON.stringify(c);h.send(m);},close:async()=>{await h.disconnect(),this.subscriptions.delete(s),i.info(`Subscription ${s} closed`);},suspend:()=>{h.suspend();},resume:async()=>{await h.resume();},on:(c,m)=>{u.has(c)||u.set(c,new Set),u.get(c).add(m);},off:(c,m)=>{let T=u.get(c);T&&T.delete(m);}};return this.subscriptions.set(s,d),d}async closeAll(){i.info("Closing all subscriptions");let t=Array.from(this.subscriptions.values()).map(e=>e.close());await Promise.all(t);}getSubscriptions(){return Array.from(this.subscriptions.values())}createTransport(t,e){let s=t.transport||this.config.defaultTransport||"websocket",r=this.config.interceptors??[];switch(s){case "websocket":return new f(t,e,r);case "sse":return new b(t,e,r);case "long-polling":return new y(t,e,r);case "streaming":return new v(t,e,r);default:throw new Error(`Unsupported transport: ${s}`)}}};var A=class{constructor(t,e){this.subscription=null;this.rooms=new Map;this.atmosphere=t,this.baseRequest=e;}async join(t,e,s={}){this.subscription||await this.connect();let r=new S(t,e,s,this.subscription);return this.rooms.set(t,r),this.send({type:"join",room:t,member:e}),i.info(`Joined room '${t}' as ${e.id}`),r}leave(t){let e=this.rooms.get(t);e&&(e.leave(),this.rooms.delete(t));}async leaveAll(){for(let t of this.rooms.values())t.leave();this.rooms.clear(),this.subscription&&(await this.subscription.close(),this.subscription=null);}room(t){return this.rooms.get(t)}joinedRooms(){return Array.from(this.rooms.keys())}async connect(){this.subscription=await this.atmosphere.subscribe(this.baseRequest,{message:t=>{this.handleMessage(t.responseBody);},error:t=>{for(let e of this.rooms.values())e.handlers.error?.(t);}});}handleMessage(t){let e;try{e=typeof t=="string"?JSON.parse(t):t;}catch{i.warn("Failed to parse room message:",t);return}let s=this.rooms.get(e.room);if(!s){i.debug(`Message for unknown room '${e.room}', ignoring`);return}s.handleIncoming(e);}send(t){this.subscription&&this.subscription.push(JSON.stringify(t));}},S=class{constructor(t,e,s,r){this._members=new Map;this._left=false;this.name=t,this.localMember=e,this.handlers=s,this.subscription=r,this._members.set(e.id,e);}get members(){return this._members}broadcast(t){if(this._left)throw new Error(`Already left room '${this.name}'`);let e={type:"broadcast",room:this.name,data:t};this.subscription.push(JSON.stringify(e));}sendTo(t,e){if(this._left)throw new Error(`Already left room '${this.name}'`);let s={type:"direct",room:this.name,data:e,target:t};this.subscription.push(JSON.stringify(s));}leave(){if(this._left)return;this._left=true;let t={type:"leave",room:this.name,member:this.localMember};this.subscription.push(JSON.stringify(t)),this._members.delete(this.localMember.id),i.info(`Left room '${this.name}'`);}handleIncoming(t){switch(t.type){case "presence":{if(!t.member)break;let e={type:t.data==="leave"?"leave":"join",room:this.name,member:t.member,timestamp:Date.now()};e.type==="join"?(this._members.set(t.member.id,t.member),this.handlers.join?.(e)):(this._members.delete(t.member.id),this.handlers.leave?.(e));break}case "broadcast":case "direct":{let e=t.member??{id:"unknown"};this.handlers.message?.(t.data,e);break}case "join":{if(Array.isArray(t.data))for(let e of t.data)this._members.set(e.id,e);this.handlers.joined?.(this.name,Array.from(this._members.values()));break}default:i.debug(`Unknown room message type: ${t.type}`);}}};var te=new R;exports.Atmosphere=R;exports.AtmosphereProtocol=g;exports.AtmosphereRooms=A;exports.BaseTransport=l;exports.LongPollingTransport=y;exports.SSETransport=b;exports.StreamingTransport=v;exports.VERSION=q;exports.WebSocketTransport=f;exports.atmosphere=te;exports.logger=i;return exports;})({});//# sourceMappingURL=index.global.js.map
//# sourceMappingURL=index.global.js.map