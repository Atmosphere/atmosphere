# Atmosphere 4.0 Release Fixes Plan

## Assessment Summary
- Overall score: 6.5/10
- New features: 7.5-8/10 (genuinely good)
- Core modernization: 6/10 (uneven — new code is modern, core is JDK 8 with syntax updates)
- Documentation: 4/10 (critical gaps)
- Build/release readiness: 5.5/10 (SNAPSHOT deps, stale configs)

---

## Phase 1: Bug Fixes (Must Fix Before Release)

### 1.1 Redis `removeExpired()` returns empty list
- **File**: `modules/durable-sessions-redis/` — `RedisSessionStore`
- **Bug**: Method iterates tokens, cleans index set, but never adds to `expired` list. Always returns `[]`.
- **Fix**: Add expired sessions to the list before returning.

### 1.2 Quarkus `LazyAtmosphereConfigurator` — static CountDownLatch never resets
- **File**: `modules/quarkus-extension/runtime/` — `LazyAtmosphereConfigurator`
- **Bug**: `static final CountDownLatch(1)` and `static final AtomicReference` — in Quarkus dev mode, second reload uses stale framework.
- **Fix**: Make resettable via shutdown observer, or use `RuntimeValue<AtomicReference<>>`.

### 1.3 `@AiEndpoint(systemPrompt=...)` never consumed
- **File**: `modules/ai/` — `AiEndpointProcessor` and `AiEndpointHandler`
- **Bug**: The annotation attribute exists and has Javadoc, but the processor never extracts or passes it to the handler.
- **Fix**: Pass annotation to handler, inject systemPrompt into prompt method invocation.

### 1.4 `@AiEndpoint(timeout=...)` sets MAX_INACTIVE globally
- **File**: `modules/ai/` — `AiEndpointProcessor`
- **Bug**: `framework.addInitParameter(ApplicationConfig.MAX_INACTIVE, ...)` is global, not per-endpoint. Second endpoint overrides first.
- **Fix**: Use per-resource suspend timeout instead of global init parameter.

### 1.5 atmosphere.js `subscription.on()` is dead code
- **File**: `atmosphere.js/src/` — `Atmosphere.subscribe()`
- **Bug**: `on(event, handler)` adds to local `eventHandlers` map but nothing dispatches through it. Silent no-op.
- **Fix**: Either wire it up to the transport event dispatch, or remove it entirely.

### 1.6 atmosphere.js never extracts session token from server response
- **File**: `atmosphere.js/src/` — `AtmosphereProtocol`
- **Bug**: `X-Atmosphere-Session-Token` header from server is never captured. Durable sessions broken client-side.
- **Fix**: Extract token from response headers after handshake and store in protocol state.

### 1.7 Redis session store logs passwords
- **File**: `modules/durable-sessions-redis/` — `RedisSessionStore`
- **Bug**: `logger.info("Redis session store connected to {}", redisUri)` prints password in plaintext.
- **Fix**: Mask URI before logging (replace password portion with `***`).

### 1.8 Redis `touch()` TOCTOU race condition
- **File**: `modules/durable-sessions-redis/` — `RedisSessionStore`
- **Bug**: Three separate Redis commands (`exists` → `get` → `setex`) with no atomicity.
- **Fix**: Use Lua script or `GETEX` (Redis 6.2+) for atomic touch.

---

## Phase 2: Documentation (Must Have Before Release)

### 2.1 Write CHANGELOG.md
- Cover the full 2.x/3.x → 4.0 journey
- Breaking changes: javax→jakarta, JDK 8→21, atmosphere.js jQuery→TypeScript
- New features: Virtual Threads, Rooms, AI/LLM, MCP, Durable Sessions, Spring Boot 4, Quarkus, Native Image
- Removed/deprecated APIs

### 2.2 Write Migration Guide (MIGRATION.md)
- Step-by-step for existing users
- Package renames (javax→jakarta)
- Minimum JDK version
- atmosphere.js migration (API changes)
- Configuration changes

---

## Phase 3: POM/Build Fixes

### 3.1 Fix SNAPSHOT `atmosphere-buildtools` in PMD plugin
- **File**: root `pom.xml:233`
- **Fix**: Align with the released version (3.0.14) used by checkstyle, or release buildtools 4.0.0 first.

### 3.2 Fix SNAPSHOT `embabel` dependency
- **File**: `modules/embabel/pom.xml:20`
- **Fix**: Exclude from release build or wait for Embabel 0.3.5 GA.

### 3.3 Fix Javadoc plugin JDK 17 references
- **File**: root `pom.xml` — release-profile and deploy-source profiles
- **Fix**: Change `<source>17</source>` to `<source>21</source>`, update Javadoc links to JDK 21 docs.

---

## Phase 4: README Fixes

### 4.1 Remove "Structured Concurrency" claim
- **File**: `README.md`
- **Bug**: Claims "Structured Concurrency" but zero `StructuredTaskScope` usage in codebase.
- **Fix**: Remove or replace with accurate description (e.g., "Virtual Thread-native").

### 4.2 Fix version contradictions
- Spring Boot "3.4+" → should be "4.0+"
- Servlet "3.0+" → should be "6.0+"

---

## Phase 5: Code Modernization

### 5.1 Convert `Deliver` to a record
- **File**: `modules/cpr/src/main/java/org/atmosphere/cpr/Deliver.java`
- Currently a mutable POJO with public fields AND getters AND setters.

### 5.2 Convert `BroadcastAction` to a record
- **File**: `modules/cpr/src/main/java/org/atmosphere/cpr/BroadcastFilter.java` (inner class)
- Already has accessor-style naming (`message()`, `action()`).

### 5.3 Convert `AsyncWriteToken` to a record
- **File**: `modules/cpr/src/main/java/org/atmosphere/cpr/DefaultBroadcaster.java` (inner class)
- Has a `destroy()` method that nulls fields — needs redesign.

### 5.4 Add `Optional` returns to public finder APIs
- `DefaultAtmosphereResourceFactory.find()` returns null → `Optional<AtmosphereResource>`
- Other finder methods as appropriate

---

## Phase 6: Additional Quality

### 6.1 Add module-level READMEs
- `modules/spring-boot-starter/README.md`
- `modules/quarkus-extension/README.md`
- `modules/cpr/README.md`
- `modules/ai/README.md`
- `modules/mcp/README.md`

### 6.2 Update atmosphere.js README
- Document React/Vue/Svelte hooks
- Document rooms/presence system
- Document AI streaming support

### 6.3 Add Redis session store tests
- Use Testcontainers (like the clustering tests already do)
- Cover save/restore, touch, expiry, removeExpired

---

## Phase 7: Build Hygiene (Nice to Have)

### 7.1 Centralize Jackson version in root POM
- Currently hardcoded `2.18.3` in 4 modules

### 7.2 Centralize Mockito version in root POM
- Currently hardcoded `5.21.0` in 8+ modules

### 7.3 Fix `durable-sessions` servlet-api scope
- Change from compile to `<scope>provided</scope>`

### 7.4 Clean up OSGi instructions
- Remove dead server references (GlassFish, Grizzly, Mortbay, WebLogic, JNLP)

### 7.5 Update stale CI workflows
- Delete or update `mavenpublish.yml` (targets JDK 1.8 / atmosphere-2.7.x)
- Update `codeql-analysis.yml` to target `main` with `@v4` actions

### 7.6 Fix SLF4J version inconsistency
- Root POM: 2.0.16 → upgrade to 2.0.17 to match starter/quarkus
